{% extends 'master.html' %}

{% block content %}
<h1 class="text-center">Coupon List</h1>

<div class="container-fluid mt-4 mx-auto">
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="w-50">
                <form method="GET">
                    <div class="input-group">
                        <input type="text" name="search" class="form-control" placeholder="Search here...">
                        <button class="btn btn-outline-secondary" type="submit">Search</button>
                    </div>
                </form>
            </div>
            <div>
                <button type="button"
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#couponModal"
                    onclick="resetCouponForm()">
                    + Add New
                </button>
            </div>
        </div>
    </div>

    <table class="table table-bordered align-middle">
        <thead>
            <tr>
                <th>Code</th>
                <th>Discount Type</th>
                <th>Discount Value</th>
                <th>Valid From</th>
                <th>Valid To</th>
                <th>Usage Limit</th>
                <th>Used Count</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for coupon in coupons %}
            <tr>
                <td>{{ coupon.code }}</td>
                <td>{{ coupon.discount_type }}</td>
                <td>{{ coupon.discount_value }}</td>
                <td>{{ coupon.valid_from }}</td>
                <td>{{ coupon.valid_to }}</td>
                <td>{{ coupon.usage_limit }}</td>
                <td>{{ coupon.used_count }}</td>
                <td>
                    {% if coupon.is_active %}
                        <span class="badge bg-success">Active</span>
                    {% else %}
                        <span class="badge bg-danger">Inactive</span>
                    {% endif %}
                </td>
                <td>
                    <button 
                        class="btn btn-warning btn-sm" 
                        data-bs-toggle="modal" 
                        data-bs-target="#couponModal"
                        onclick="editCoupon(
                            '{{ coupon.id }}',
                            '{{ coupon.code|escapejs }}',
                            '{{ coupon.discount_type|escapejs }}',
                            '{{ coupon.discount_value }}',
                            '{{ coupon.valid_from|date:"Y-m-d" }}',
                            '{{ coupon.valid_to|date:"Y-m-d" }}',
                            '{{ coupon.usage_limit }}',
                            '{{ coupon.used_count }}',
                            '{{ coupon.is_active }}'
                        )"
                    >
                        <i class="bi bi-pencil-square"></i> Edit
                    </button>
                    <a href="{% url 'delete_coupon' coupon.id %}" class="btn btn-sm {% if coupon.is_active %}btn-danger{% else %}btn-success{% endif %}">
                       <i class="bi bi-trash"></i> Delete
                    </a>
                    <a href="{% url 'toggle_coupon_status' coupon.id %}" class="btn btn-sm {% if coupon.is_active %}btn-danger{% else %}btn-success{% endif %}">
                        {% if coupon.is_active %}Inactive{% else %}Active{% endif %}
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock content %}

{% block modal %}
<div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="POST" action="{% url 'coupon_list' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="couponModalLabel">Create coupon</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="coupon_id" id="coupon_id">

                    <div class="mb-3">
                        <label for="code" class="form-label">Coupon Code</label>
                        <input type="text" id="code" name="code" class="form-control" placeholder="Enter coupon code"
                            required>
                    </div>
                    <div class="mb-3">
                        <label for="discount_type" class="form-label">Discount Type</label>
                        <select id="discount_type" name="discount_type" class="form-select" required>
                            <option value="fixed">Fixed</option>
                            <option value="percent">Percentage</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="discount_value" class="form-label">Discount Value</label>
                        <input type="number" id="discount_value" name="discount_value" class="form-control"
                            placeholder="Enter discount value" required>
                    </div>
                    <div class="mb-3">
                        <label for="valid_from" class="form-label">Valid From</label>
                        <input type="date" id="valid_from" name="valid_from" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="valid_to" class="form-label">Valid To</label>
                        <input type="date" id="valid_to" name="valid_to" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="usage_limit" class="form-label">Usage Limit</label>
                        <input type="number" id="usage_limit" name="usage_limit" class="form-control"
                            placeholder="Enter uses limit" required>
                    </div>
                    <div class="mb-3">
                        <label for="used_count" class="form-label">Used Count</label>
                        <input type="number" id="used_count" name="used_count" class="form-control"
                            placeholder="Enter used count" required>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select id="status" name="status" class="form-select" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function editCoupon(
        id, code, discount_type, discount_value,
        valid_from, valid_to, usage_limit, used_count, is_active
    ) {
        document.getElementById('coupon_id').value = id;
        document.getElementById('code').value = code;
        document.getElementById('discount_type').value = discount_type;
        document.getElementById('discount_value').value = discount_value;
        document.getElementById('valid_from').value = valid_from;
        document.getElementById('valid_to').value = valid_to;
        document.getElementById('usage_limit').value = usage_limit;
        document.getElementById('used_count').value = used_count;

        document.getElementById('status').value =
            (is_active === 'True' || is_active === true) ? 'active' : 'inactive';

        document.getElementById('couponModalLabel').textContent = 'Edit coupon';
    }

    function resetCouponForm() {
        document.getElementById('coupon_id').value = '';
        document.getElementById('code').value = '';
        document.getElementById('discount_type').value = 'fixed';
        document.getElementById('discount_value').value = '';
        document.getElementById('valid_from').value = '';
        document.getElementById('valid_to').value = '';
        document.getElementById('usage_limit').value = '';
        document.getElementById('used_count').value = '';
        document.getElementById('status').value = 'active';

        document.getElementById('couponModalLabel').textContent = 'Create coupon';
    }
</script>
{% endblock modal %}
