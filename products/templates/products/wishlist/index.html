{% extends 'master.html' %}

{% block content %}
<h1 class="text-center mb-4">Product Wish List</h1>

<div class="col-lg-12">
    <div class="row g-4">

        {% if products %}
            {% for product in products %}
            {% with badge=product.display_badge.0 badge_class=product.display_badge.1 %}
            <div class="col-xl-3 col-lg-4 col-md-6">
                <div class="card product-card bg-dark border-0 text-light hover-glow h-100">

                    <!-- Product Image -->
                    <div class="position-relative">
                        <img src="{{ product.get_primary_image }}"
                             alt="{{ product.name }}"
                             class="card-img-top"
                             style="height: 200px; object-fit: cover;">

                        {% if badge %}
                        <div class="product-badge position-absolute top-0 start-0 {{ badge_class }} text-white px-3 py-1 rounded-end">
                            {{ badge }}
                        </div>
                        {% endif %}

                        <!-- Wishlist Icon -->
                        <button
                            class="btn-wishList card-wishlist position-absolute top-0 end-0 mt-2 me-2 rounded-circle"
                            aria-label="Toggle wishlist"
                            onclick="toggleWishlist(this, {{ product.id }})">
                            <i class="{% if product.id in user_wishlist_ids %}bi bi-heart-fill text-danger{% else %}bi bi-heart text-white{% endif %} fs-5"></i>
                        </button>
                    </div>

                    <!-- Product Info -->
                    <div class="card-body text-center d-flex flex-column">

                        <a href="{% url 'product_detail' product.slug %}"
                           class="fs-5 fw-semibold text-decoration-none text-light mb-1">
                            {{ product.name|truncatechars:40 }}
                        </a>

                        <!-- Rating -->
                        <div class="text-warning mb-2">
                            {% for i in "12345" %}
                                {% if forloop.counter <= product.average_rating|default:0 %}
                                    <i class="fas fa-star"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <!-- Price -->
                        <div class="fw-bold mb-2">
                            {% if product.on_sale %}
                                <span class="text-decoration-line-through text-muted">${{ product.price }}</span>
                                <span class="text-danger ms-2">${{ product.sale_price }}</span>
                            {% else %}
                                <span>${{ product.price }}</span>
                            {% endif %}
                        </div>

                        <!-- Stock -->
                        <div class="mb-3">
                            {% if product.in_stock %}
                                <span class="badge bg-success">In Stock</span>
                            {% else %}
                                <span class="badge bg-secondary">Out of Stock</span>
                            {% endif %}
                        </div>

                        <!-- Add to Cart -->
                        <button
                            class="btn btn-outline-primary mt-auto btn-add-cart"
                            data-product-id="{{ product.id }}">
                            <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                        </button>

                    </div>
                </div>
            </div>
            {% endwith %}
            {% endfor %}
        {% else %}
            <!-- Empty Wishlist -->
            <div class="col-12">
                <div class="text-center text-muted py-5">
                    <i class="bi bi-heart fs-1"></i>
                    <h5 class="mt-3">Your wishlist is empty</h5>
                    <p>Browse products and add items you love ❤️</p>
                </div>
            </div>
        {% endif %}

    </div>
</div>

<script>
    function toggleWishlist(btn, productId) {
        fetch("{% url 'products:toggle_wishlist' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({
                product_id: productId
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const icon = btn.querySelector("i");

                if (data.action === "added") {
                    icon.classList.remove("bi-heart");
                    icon.classList.add("bi-heart-fill", "text-danger");
                } else {
                    icon.classList.remove("bi-heart-fill", "text-danger");
                    icon.classList.add("bi-heart");
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {

            document.querySelectorAll('.btn-add-cart').forEach(btn => {
                btn.addEventListener('click', function () {

                const productId = this.dataset.productId;
                const qtyInput = document.getElementById('quantity');
                const quantity = parseInt(qtyInput?.value, 5) || 1;

                fetch("{% url 'add_to_cart' %}", {
                    method: "POST",
                    headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: new URLSearchParams({
                        product_id: productId,
                        quantity: quantity
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                    cartItems = Object.values(data.cart).map(item => ({
                        id: item.product_id,
                        name: item.name,
                        price: parseFloat(item.price),
                        quantity: item.quantity,
                        image: item.image 
                    }));
                    // UI feedback
                    btn.innerHTML = "✔ Added";
                    btn.disabled = true;

                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-shopping-cart me-2"></i>Add to Cart';
                        btn.disabled = false;
                    }, 1000);
                    }
                });

                });
            });
        });
</script>
{% endblock content %}
