{% extends "base.html" %}
{% load static %}
{% block styles %}
  <link rel="stylesheet" href="{% static 'frontend/css/checkout.css' %}">
{% endblock styles %}
{% block contents %}
<div class="container py-5">
  <div class="row g-4">
    <!-- Left Column - Form -->
    <div class="col-lg-7">
      <div class="checkout-card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
          <h4 class="mb-4 fw-bold" style="color: var(--text-primary);">Shipping Information</h4>
          
          <form id="checkoutForm">
            {% csrf_token %}
            
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label fw-semibold small" style="color: var(--text-secondary);">FULL NAME</label>
                <input type="text" class="form-control form-control-lg border-2 checkout-input" name="full_name" placeholder="John Doe" required>
              </div>
              
              <div class="col-md-6">
                <label class="form-label fw-semibold small" style="color: var(--text-secondary);">EMAIL ADDRESS</label>
                <input type="email" class="form-control form-control-lg border-2 checkout-input" name="email" placeholder="john@example.com" required>
              </div>
              
              <div class="col-md-6">
                <label class="form-label fw-semibold small" style="color: var(--text-secondary);">PHONE NUMBER</label>
                <input type="tel" class="form-control form-control-lg border-2 checkout-input" name="phone" placeholder="+1 (555) 000-0000" required>
              </div>
              
              <div class="col-12">
                <label class="form-label fw-semibold small" style="color: var(--text-secondary);">STREET ADDRESS</label>
                <input type="text" class="form-control form-control-lg border-2 checkout-input" name="address" placeholder="123 Main Street, Apt 4B" required>
              </div>
              
              <div class="col-md-6">
                <label class="form-label fw-semibold small" style="color: var(--text-secondary);">CITY</label>
                <input type="text" class="form-control form-control-lg border-2 checkout-input" name="city" placeholder="New York" required>
              </div>
              
              <div class="col-md-6">
                <label class="form-label fw-semibold small" style="color: var(--text-secondary);">STATE</label>
                <input type="text" class="form-control form-control-lg border-2 checkout-input" name="state" placeholder="NY" required>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold small" style="color: var(--text-secondary);">COUNTRY</label>
                <input type="text" class="form-control form-control-lg border-2 checkout-input" name="country" placeholder="USA" required>
              </div>
              
              <div class="col-md-6">
                <label class="form-label fw-semibold small" style="color: var(--text-secondary);">ZIP CODE</label>
                <input type="text" class="form-control form-control-lg border-2 checkout-input" name="zip" placeholder="10001" required>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Coupon Section -->
      <div class="checkout-card border-0 shadow-sm coupon-gradient">
        <div class="card-body p-4">
          <h6 class="text-white mb-3 fw-semibold">Have a coupon code?</h6>
          <div class="input-group input-group-lg">
            <input type="text" id="couponCode" class="form-control border-0 coupon-input" placeholder="Enter code">
            <button type="button" class="btn btn-light px-4 fw-semibold" onclick="applyCoupon()">Apply</button>
          </div>
          <small class="text-white-50 d-block mt-2">Get instant discount on your order</small>
        </div>
      </div>
    </div>

    <!-- Right Column - Order Summary -->
    <div class="col-lg-5">
      <div class="position-sticky" style="top: 100px;">
        <div class="checkout-card border-0 shadow-sm">
          <div class="card-body p-4">
            <h4 class="mb-4 fw-bold" style="color: var(--text-primary);">Order Summary</h4>
            
            <div class="d-flex justify-content-between mb-3 pb-3 summary-border">
              <span style="color: var(--text-secondary);">Subtotal</span>
              <span class="fw-semibold" id="subtotal" style="color: var(--text-primary);">$0.00</span>
            </div>
            
            <div class="d-flex justify-content-between mb-3 pb-3 summary-border" id="discountRow" style="display: none !important;">
              <span class="text-success">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-tag-fill me-1" viewBox="0 0 16 16">
                  <path d="M2 1a1 1 0 0 0-1 1v4.586a1 1 0 0 0 .293.707l7 7a1 1 0 0 0 1.414 0l4.586-4.586a1 1 0 0 0 0-1.414l-7-7A1 1 0 0 0 6.586 1zm4 3.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                </svg>
                Discount
              </span>
              <span class="text-success fw-semibold" id="discount">-$0.00</span>
            </div>
            
            <div class="d-flex justify-content-between mb-4 pb-3 summary-border">
              <span style="color: var(--text-secondary);">Shipping</span>
              <span class="fw-semibold" style="color: var(--text-primary);">$50.00</span>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h5 class="mb-0 fw-bold" style="color: var(--text-primary);">Total</h5>
              <h4 class="mb-0 fw-bold" id="grandTotal" style="color: var(--primary);">$0.00</h4>
            </div>
            
            <button type="submit" form="checkoutForm" class="btn btn-checkout btn-lg w-100 py-3 fw-semibold shadow-sm">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-lock-fill me-2" viewBox="0 0 16 16">
                <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2"/>
              </svg>
              Secure Checkout
            </button>
            
            <div class="text-center mt-3">
              <small style="color: var(--text-secondary);">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-shield-check me-1" viewBox="0 0 16 16">
                  <path d="M5.338 1.59a61 61 0 0 0-2.837.856.48.48 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.7 10.7 0 0 0 2.287 2.233c.346.244.652.42.893.533q.18.085.293.118a1 1 0 0 0 .101.025 1 1 0 0 0 .1-.025q.114-.034.294-.118c.24-.113.547-.29.893-.533a10.7 10.7 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.8 11.8 0 0 1-2.517 2.453 7 7 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7 7 0 0 1-1.048-.625 11.8 11.8 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 63 63 0 0 1 5.072.56"/>
                  <path d="M10.854 5.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 7.793l2.646-2.647a.5.5 0 0 1 .708 0"/>
                </svg>
                Your payment information is secure
              </small>
            </div>
          </div>
        </div>
        
        <!-- Trust Badges -->
        <div class="d-flex justify-content-center gap-3 mt-4" style="color: var(--text-secondary);">
          <small>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-truck me-1" viewBox="0 0 16 16">
              <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5zm1.294 7.456A2 2 0 0 1 4.732 11h5.536a2 2 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456M12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2"/>
            </svg>
            Free Shipping
          </small>
          <small>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-counterclockwise me-1" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2z"/>
              <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466"/>
            </svg>
            Easy Returns
          </small>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
let appliedCoupon = null;

function applyCoupon() {
  const couponInput = document.getElementById('couponCode');
  
  fetch("{% url 'apply_coupon' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: `code=${couponInput.value}`
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      appliedCoupon = data;
      document.getElementById('discountRow').style.display = 'flex';
      calculateTotal();

      couponInput.classList.add('is-valid');
      setTimeout(() => couponInput.classList.remove('is-valid'), 3000);
    } else {
      alert(data.message);
      couponInput.classList.add('is-invalid');
      setTimeout(() => couponInput.classList.remove('is-invalid'), 3000);
    }
  })
  .catch(err => {
    console.error('Error applying coupon:', err);
    alert('Failed to apply coupon. Please try again.');
  });
}

function calculateTotal() {
  const subtotal = Number({{ cart_total }});
  const discount = appliedCoupon ? Number(appliedCoupon.discount) : 0;
  const shipping = 50;

  document.getElementById("subtotal").innerText = `$${subtotal.toFixed(2)}`;
  document.getElementById("discount").innerText = `-$${discount.toFixed(2)}`;

  const grandTotal = subtotal - discount + shipping;
  document.getElementById("grandTotal").innerText = `$${grandTotal.toFixed(2)}`;
  
  if (discount > 0) {
    document.getElementById('discountRow').style.display = 'flex';
  }
}

calculateTotal();
</script>
{% endblock %}